# JPEG文件格式解析

**简介**：本文档适用于未接触jpeg文件格式的人提前了解需要编解码的图片格式，对于学习和理解HDL代码结构也有一定帮助。



## 一、JEPG文件格式

#### 1.1 文件内容

1、使用vscode的hex编辑器打开test.jpg，可以发现文件数据的单位是一个字节8位，由16进制表示

<img src="讲解截图/1.jpg" alt="1"  />



#### 1.2 文件结构

##### 1.2.1 文件段分类

文件**除数据起始（FF D8）和结束标志（FF D9）**以外，由多个数据段组成。

数据段的格式为 **FF + XX + XX XX+ N x 数据**。

+ FF：起始标志

+ XX : 段类型

+ XX XX ：段长度，不算起始FF和段类型，算上本指令消耗的2个字节，实际数据最大可用65533字节

  

如上图所示，例如第一个段 FF E0 00 10 4A 46 49 46 00 01 01 01 00 60 00 60 00 00 。 使用到的段类型如下：

| 段类型 | 含义 | 具体描述                                                     |
| :----: | :--: | :----------------------------------------------------------- |
|   D8   | SOI  | 必选，文件起始标志                                           |
|   E0   | APP0 | 必选，用于指示这是一张JFIF标准的JPEG图片，包含一部分基本信息 |
|   DB   | DQT  | 必选，用于存储量化表并设置对应ID                             |
| C0/C2  | SOF  | 必选，图片解析元数据，包含图片长宽、精度等信息。注：此处C0表示Baseline ，C2表示渐进式，对于网络传输来说常用于渐进式，表现为图像多次显示逐渐清晰; 对于硬件编程来说，通常使用Baseline，即扫描一次直接传输完毕，表现为图像从上到下逐渐显示 |
|   C4   | DHT  | 必选，用于存储编码的查表数据                                 |
|   DA   | SOS  | 必选，扫描开始，包含编码通道选择等信息                       |
|   D9   | EOI  | 必选，文件结束标志                                           |
|   FE   | COM  | 可选，注释内容                                               |
|   DD   | DRI  | 可选，熵编码迭代的复位标记                                   |

除以上10个通用标准以外，还有另外20个不常见的段类型此处不再展开。另外，为避免编码过程中产生 FFXX触发段类型，当数据内出现FF时，在后面强制插入00再接后面的数据。



##### 1.2.2 文件段内容解析(更新ing)

具体的段内容结构如下，以字节为单位：

+ SOI：

| 字节编号 | 16进制值 | 说明         |
| -------- | -------- | ------------ |
| 1        | FF       | 固定，段标志 |
| 2        | D8       | 固定，段类型 |



+ APP0：

![2](讲解截图/2.png)

| 字节编号 | 16进制值                            | 说明                                                      |
| -------- | ----------------------------------- | --------------------------------------------------------- |
| 1        | FF                                  | 固定，段标志                                              |
| 2        | E0                                  | 固定，段类型                                              |
| 3-4      | 00 10（默认） + 3 x N(缩略图像素数) | 自定义，段长度，如果没有缩略图就是00 10                   |
| 5-9      | 4A46494600                          | 固定，JFIF字符串                                          |
| 10-11    | 0101（默认）                        | 自定义，版本号，一般为0101，即JFIF版本 1.1                |
| 12       | 01                                  | 自定义，密度单位（0：无单位；1：点数/英寸；2：点数/厘米） |
| 13-14    | XX                                  | 自定义，图像横向像素数                                    |
| 15-16    | XX                                  | 自定义，图像纵向像素数                                    |
| 17       | 00（默认）                          | 自定义，缩略图横向像素数，没有就是00                      |
| 18       | 00（默认）                          | 自定义，缩略图纵向像素数，没有就是00                      |
| 19……     | XX                                  | 自定义，缩略图RGB数据，每3个字节为一个像素，没有就不写    |

+ DQT：


![3](讲解截图/3.png)

| 字节编号 | 16进制值 | 说明                                                         |
| -------- | -------- | ------------------------------------------------------------ |
| 1        | FF       | 固定，段标志                                                 |
| 2        | DB       | 固定，段类型                                                 |
| 3-4      | 43(默认) | 自定义，段长度，对于8b的数据表来说，默认43，16b的数据此处为83 |
| 4        | XX       | 自定义，P/T值，每个字节高四位（0：8b 数据 1:16b数据），低四位表示表行ID |
| 5……      | XX       | 自定义，8x8共64个表格值，对于8b的格式，一个字节对应一个数据；对于16b的格式则需要两个字节。按照Zigzag顺序从左上往右下扫描。 |

+ SOF：

  ![4](讲解截图/4.png)

| 字节编号 | 16进制值   | 说明                                                         |
| -------- | ---------- | ------------------------------------------------------------ |
| 1        | FF         | 固定，段标志                                                 |
| 2        | C0         | 固定，段类型，C2等硬件不方便实现的类型暂不说明，此处只说明C0，即Baseline类型 |
| 3-4      | 11（默认） | 自定义，段长度                                               |
| 5        | 08         | 自定义，采样精度，Baseline只有08                             |
| 6~7      | XX         | 自定义，图像横向像素数                                       |
| 8~9      | XX         | 自定义，图像纵向像素数                                       |
| 10       | 03（默认） | 自定义，图像分量，对于YUV来说只有3个分量，灰度就只有1个      |
| 11~13    | XX XX XX   | 自定义，分量ID 0 8b+H0分量水平采样 4b+V0分量垂直采样 4b+T0当前分量量化表ID 8b |
| 14~16    | XX XX XX   | 自定义，分量ID 1 8b+H1分量水平采样 4b+V1分量垂直采样 4b+T1当前分量量化表ID 8b |
| 17~19    | XX XX XX   | 自定义，分量ID 2 8b+H2分量水平采样 4b+V2分量垂直采样 4b+T2当前分量量化表ID 8b |
| 20……     | XX         | 自定义，YUV此处已经结束，如果其他编码方式可能还有后续的分量编码 |

+ DHT：

| 字节编号 | 16进制值 | 说明           |
| -------- | -------- | -------------- |
| 1        | FF       | 固定，段标志   |
| 2        | C4       | 固定，段类型   |
| 3-4      | XX       | 自定义，段长度 |



+ EOI：

| 字节编号 | 16进制值 | 说明   |
| -------- | -------- | ------ |
| 1        | FF       | 段标志 |
| 2        | D9       | 段类型 |



总得来说，JPEG文件基本由 SOI + APP0 + N个DQT + SOF + N个DHT + SOS + EOI 组成，具体的数据段解析到编码过程中实时解析。



## 二、jpeg文件编码过程（更新ing

1、输入的图像假定为长宽已知的RGB888 数据流

2、首先将每个像素的RGB888转为YCBCR 444

3、

